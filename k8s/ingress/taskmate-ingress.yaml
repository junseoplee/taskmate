---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: taskmate-ingress
  namespace: taskmate
  labels:
    app: taskmate
    tier: ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    # Session affinity for Rails applications
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "taskmate-route"
    nginx.ingress.kubernetes.io/session-cookie-expires: "86400"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "86400"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"
spec:
  rules:
  # Main frontend application
  - host: taskmate.local
    http:
      paths:
      # API routes - order matters!
      - path: /api/v1/auth
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 3000
      - path: /api/v1/users
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 3000
      - path: /api/v1/tasks
        pathType: Prefix
        backend:
          service:
            name: task-service
            port:
              number: 3001
      - path: /api/v1/analytics
        pathType: Prefix
        backend:
          service:
            name: analytics-service
            port:
              number: 3002
      - path: /api/v1/file_categories
        pathType: Prefix
        backend:
          service:
            name: file-service
            port:
              number: 3003
      - path: /api/v1/file_attachments
        pathType: Prefix
        backend:
          service:
            name: file-service
            port:
              number: 3003
      - path: /api/v1/files
        pathType: Prefix
        backend:
          service:
            name: file-service
            port:
              number: 3003
      # All other routes go to frontend
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 3100
---
# Development ingress for direct service access
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: taskmate-services-ingress
  namespace: taskmate
  labels:
    app: taskmate
    tier: ingress
    purpose: development
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
spec:
  rules:
  # Direct service access for development
  - host: user.taskmate.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 3000
  - host: task.taskmate.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: task-service
            port:
              number: 3001
  - host: analytics.taskmate.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: analytics-service
            port:
              number: 3002
  - host: files.taskmate.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: file-service
            port:
              number: 3003